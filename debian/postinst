#!/bin/sh
# postinst script for haproxyweb
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

case "$1" in
    configure)
	
		if ! getent group haproxyweb > /dev/null 2>&1
		then
			addgroup --system haproxyweb >/dev/null
		fi
		if ! getent passwd haproxyweb > /dev/null 2>&1
		then
			adduser --system --home /usr/share/haproxyweb/ --ingroup haproxyweb --no-create-home --shell /bin/false haproxyweb
		fi    
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac


if [ ! -d "/etc/haproxyweb" ]; 
then
	mkdir -p /etc/haproxyweb
	cp /usr/share/haproxyweb/haproxyweb.ini /etc/haproxyweb/
	cp /usr/share/haproxyweb/haproxyweb.ini.sqlite /etc/haproxyweb/
	chown -R haproxyweb:haproxyweb /etc/haproxyweb
fi


[ ! -d "/var/log/haproxyweb" ] && mkdir -p /var/log/haproxyweb
chown -R haproxyweb:haproxyweb /var/log/haproxyweb
[ ! -d "/etc/pki" ] && mkdir -p /etc/pki
chown -R haproxyweb:haproxyweb /etc/pki
[ ! -d "/etc/pki/CA" ] && mkdir -p /etc/pki/CA
[ ! -d "/etc/pki/CA/certs" ] && mkdir -p /etc/pki/CA/certs
[ ! -d "/etc/pki/CA/private" ] && mkdir -p /etc/pki/CA/private
[ -L "/etc/apache2/sites-enabled/000-default.conf" ] && rm /etc/apache2/sites-enabled/000-default.conf
[ -f /usr/share/haproxyweb/haproxy_reload.sh ] && chmod +x /usr/share/haproxyweb/haproxy_reload.sh
[ -f /usr/share/haproxyweb/create_database.sh ] && chmod +x /usr/share/haproxyweb/create_database.sh
[ -f /tmp/haproxy.cfg ] && chown haproxyweb:haproxyweb /tmp/haproxy.cfg
[ -f /etc/apache2/ports.conf ] && sed -i 's/Listen 80/Listen 10001/' /etc/apache2/ports.conf

cd /tmp
tar zxvf Django-1.8.1.tar.gz
cd /tmp/Django-1.8.1
python setup.py install --no-compile -O0 --install-layout=deb

#apt-get -y install build-essential make g++ libssl-dev
#cd /tmp
#tar xvf haproxy-1.5.12.tar.gz
#cd haproxy-1.5.12
#make USE_OPENSSL=yes
#sudo make install

#service mysql restart
#service apache2 restart
#/usr/share/haproxyweb/haproxy_reload.sh
#wget http://127.0.0.1:8000/dummy/
#service haproxy restart

service rsyslog restart


# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
